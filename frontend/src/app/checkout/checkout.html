<div class="checkout-page">
    <div class="checkout-layout">
        <!-- Sidebar Stepper -->
        <aside class="checkout-sidebar">
            <div class="sidebar-header">
                <img src="images/greenie-culture-logo.png" alt="Greenie Culture" class="logo">
            </div>

            <div class="vertical-stepper">
                <div class="step-item" [class.active]="currentStep === 1" [class.completed]="currentStep > 1"
                    (click)="currentStep = 1">
                    <div class="step-marker">
                        <span class="step-num">1</span>
                        <span class="step-check">âœ“</span>
                    </div>
                    <div class="step-label">
                        <h4>Customer Details</h4>
                        <p>Name, Email & Address</p>
                    </div>
                </div>

                <div class="step-line" [class.active]="currentStep >= 2"></div>

                <div class="step-item" [class.active]="currentStep === 2" [class.completed]="currentStep > 2"
                    (click)="currentStep >= 2 ? currentStep = 2 : null">
                    <div class="step-marker">
                        <span class="step-num">2</span>
                        <span class="step-check">âœ“</span>
                    </div>
                    <div class="step-label">
                        <h4>Order Summary</h4>
                        <p>Review your items</p>
                    </div>
                </div>

                <div class="step-line" [class.active]="currentStep >= 3"></div>

                <div class="step-item" [class.active]="currentStep === 3"
                    (click)="currentStep >= 3 ? currentStep = 3 : null">
                    <div class="step-marker">
                        <span class="step-num">3</span>
                        <span class="step-check">âœ“</span>
                    </div>
                    <div class="step-label">
                        <h4>Payment Method</h4>
                        <p>Secure checkout</p>
                    </div>
                </div>
            </div>

            <div class="sidebar-footer">
                <p>Â© 2026 Greenie Culture</p>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="checkout-main">
            <div class="content-container">
                <!-- Step 1: Basic Details -->
                <div class="step-content" *ngIf="currentStep === 1">
                    <div class="step-header">
                        <h2>Personal Details</h2>
                        <a routerLink="/login" class="signin-link" *ngIf="!(authService.isLoggedIn$ | async)">Already
                            have an account? Sign in</a>
                    </div>
                    <div class="input-grid">
                        <div class="input-field">
                            <label>First Name</label>
                            <input type="text" [(ngModel)]="firstName" placeholder="e.g. Rahul" class="checkout-input">
                        </div>
                        <div class="input-field">
                            <label>Last Name</label>
                            <input type="text" [(ngModel)]="lastName" placeholder="e.g. Sharma" class="checkout-input">
                        </div>
                        <div class="input-field">
                            <label>Email Address</label>
                            <input type="email" [(ngModel)]="contactEmail" placeholder="rahul@example.com"
                                class="checkout-input">
                        </div>
                        <div class="input-field">
                            <label>Mobile Number</label>
                            <div class="phone-wrapper">
                                <span class="prefix">+91</span>
                                <input type="tel" [(ngModel)]="phone" placeholder="9876543210" class="checkout-input">
                            </div>
                        </div>
                    </div>

                    <div class="section-divider"></div>

                    <div class="step-header">
                        <h2>Shipping Address</h2>
                    </div>
                    <div class="input-grid">
                        <div class="input-field full-width">
                            <label>Complete Address</label>
                            <input type="text" [(ngModel)]="address" placeholder="Flat No, Apartment, Street name"
                                class="checkout-input">
                        </div>
                        <div class="input-field">
                            <label>City</label>
                            <div class="autocomplete-wrapper">
                                <input type="text" [(ngModel)]="city" (input)="onCityInput()" (blur)="closeDropdowns()"
                                    placeholder="Search City" class="checkout-input">
                                <div class="dropdown" *ngIf="showCityDropdown && filteredCities.length > 0">
                                    <div class="option" *ngFor="let city of filteredCities" (click)="selectCity(city)">
                                        {{ city }}</div>
                                </div>
                            </div>
                        </div>
                        <div class="input-field">
                            <label>State</label>
                            <div class="autocomplete-wrapper">
                                <input type="text" [(ngModel)]="stateName" (input)="onStateInput()"
                                    (blur)="closeDropdowns()" placeholder="Search State" class="checkout-input">
                                <div class="dropdown" *ngIf="showStateDropdown && filteredStates.length > 0">
                                    <div class="option" *ngFor="let state of filteredStates"
                                        (click)="selectState(state)">{{ state }}</div>
                                </div>
                            </div>
                        </div>
                        <div class="input-field">
                            <label>Pincode</label>
                            <input type="text" [(ngModel)]="pincode" placeholder="400001" class="checkout-input">
                        </div>
                    </div>

                    <div class="action-bar">
                        <button class="primary-btn" [disabled]="!isStep1Valid()" (click)="nextStep()">Continue to
                            Summary</button>
                    </div>
                </div>

                <!-- Step 2: Order Summary -->
                <div class="step-content" *ngIf="currentStep === 2">
                    <div class="step-header">
                        <h2>Review Your Order</h2>
                    </div>

                    <div class="summary-card">
                        <div class="order-items-list">
                            <div class="cart-item" *ngFor="let item of items()">
                                <div class="item-visual">
                                    <img [src]="item.image" [alt]="item.name">
                                    <span class="qty">{{ item.quantity }}</span>
                                </div>
                                <div class="item-details">
                                    <h3>{{ item.name }}</h3>
                                    <p *ngIf="item.planter">{{ item.planter }} Planter</p>
                                </div>
                                <div class="item-price">
                                    â‚¹{{ item.price * item.quantity }}
                                </div>
                            </div>
                        </div>

                        <div class="promo-box">
                            <input type="text" placeholder="Coupon Code" class="checkout-input">
                            <button class="secondary-btn">Apply</button>
                        </div>

                        <div class="billing-summary">
                            <div class="bill-row">
                                <span>Subtotal</span>
                                <span>â‚¹{{ totalAmount() }}</span>
                            </div>
                            <div class="bill-row">
                                <span>Delivery Charges</span>
                                <span class="success-text">FREE</span>
                            </div>
                            <div class="bill-row grand-total">
                                <span>Amount Payable</span>
                                <span>â‚¹{{ totalAmount() }}</span>
                            </div>
                        </div>
                    </div>

                    <div class="action-bar">
                        <button class="back-link" (click)="prevStep()">Back to Details</button>
                        <button class="primary-btn" (click)="nextStep()">Continue to Payment</button>
                    </div>
                </div>

                <!-- Step 3: Payment Section -->
                <div class="step-content" *ngIf="currentStep === 3">
                    <div class="step-header">
                        <h2>Select Payment Method</h2>
                    </div>

                    <div class="payment-grid">
                        <div class="pay-method" [class.selected]="selectedPayment === 'upi'"
                            (click)="selectedPayment = 'upi'">
                            <input type="radio" name="pay" [checked]="selectedPayment === 'upi'">
                            <div class="method-info">
                                <div class="method-main">
                                    <i class="fas fa-mobile-alt"></i>
                                    <span>UPI / Google Pay / PhonePe</span>
                                </div>
                                <img src="https://cdn-icons-png.flaticon.com/128/10424/10424075.png" alt="UPI"
                                    class="icon">
                            </div>
                        </div>

                        <!-- QR Scanner Section -->
                        <div class="qr-scanner-container" *ngIf="selectedPayment === 'upi'">
                            <div class="qr-card">
                                <h3>Scan & Pay</h3>
                                <div class="qr-image">
                                    <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=upi://pay?pa=greenieculture@upi&pn=GreenieCulture&am={{totalAmount()}}&cu=INR"
                                        alt="QR Code">
                                </div>
                                <p>Open any UPI App to scan</p>
                                <div class="simulated-payment-info">
                                    <span class="loader-dot"></span>
                                    <span>Waiting for payment...</span>
                                </div>
                            </div>
                        </div>



                        <div class="pay-method" [class.selected]="selectedPayment === 'cod'"
                            (click)="selectedPayment = 'cod'">
                            <input type="radio" name="pay" [checked]="selectedPayment === 'cod'">
                            <div class="method-info">
                                <div class="method-main">
                                    <i class="fas fa-hand-holding-usd"></i>
                                    <span>Cash on Delivery</span>
                                </div>
                                <img src="https://cdn-icons-png.flaticon.com/128/649/649454.png" alt="COD" class="icon">
                            </div>
                        </div>
                    </div>

                    <div class="action-bar">
                        <button class="back-link" (click)="prevStep()">Review Order</button>
                        <button class="primary-btn checkout-btn" [disabled]="isProcessing" (click)="onPayNow()">
                            <span *ngIf="!isProcessing">Place Order - â‚¹{{ totalAmount() }}</span>
                            <span *ngIf="isProcessing">Processing Payment...</span>
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Success Modal -->
<div class="success-overlay" *ngIf="showSuccessModal">
    <div class="success-modal">
        <div class="success-icon">
            <i class="fas fa-check-circle"></i>
        </div>
        <h2>Order Placed Successfully!</h2>
        <p>Thank you for shopping with Greenie Culture ðŸŒ¿</p>
        <div class="modal-actions">
            <button class="review-btn" (click)="finishWithReview()">
                <i class="fas fa-star"></i> Write a Review
            </button>
            <button class="skip-btn" (click)="finishWithoutReview()">
                Skip for now
            </button>
        </div>
    </div>
</div>

<!-- Review Dialog -->
<app-review-dialog *ngIf="showReviewDialog" (submitReview)="handleReviewSubmit($event)"
    (close)="showReviewDialog = false; finishOrder()">
</app-review-dialog>