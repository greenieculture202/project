<div class="user-panel-container">
    <div class="sidebar">
        <div class="user-info">
            <div class="avatar">
                <i class="fas fa-user"></i>
            </div>
            <h3>{{ authService.currentUser$ | async }}</h3>
            <p>Premium Member</p>
        </div>
        <nav class="side-nav">
            <a class="nav-item" [class.active]="activeTab === 'dashboard'" (click)="setActiveTab('dashboard')">
                <i class="fas fa-th-large"></i>
                <span>Dashboard</span>
            </a>
            <a class="nav-item" [class.active]="activeTab === 'orders'" (click)="setActiveTab('orders')">
                <i class="fas fa-shopping-bag"></i>
                <span>My Orders</span>
            </a>

            <a class="nav-item" [class.active]="activeTab === 'settings'" (click)="setActiveTab('settings')">
                <i class="fas fa-user-edit"></i>
                <span>Profile Settings</span>
            </a>
            <a class="nav-item logout" (click)="logout()">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </a>
        </nav>
    </div>

    <main class="content">
        <div class="loading-overlay" *ngIf="isLoading">
            <div class="spinner"></div>
            <p>Loading your garden stats...</p>
        </div>

        <!-- Dashboard Tab -->
        <ng-container *ngIf="activeTab === 'dashboard' && !isLoading">
            <header class="content-header">
                <h1>My Garden Dashboard (Live)</h1>
                <p>Welcome back, {{ authService.currentUser$ | async }}! Here's what's happening with your garden.</p>
            </header>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon orders">
                        <i class="fas fa-box"></i>
                    </div>
                    <div class="stat-details">
                        <span class="stat-value">{{ dashboardData.stats.totalOrders }}</span>
                        <span class="stat-label">Total Orders</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon points">
                        <i class="fas fa-star"></i>
                    </div>
                    <div class="stat-details">
                        <span class="stat-value">{{ dashboardData.stats.greenPoints }}</span>
                        <span class="stat-label">Green Points</span>
                    </div>
                </div>
            </div>

            <section class="recent-orders">
                <div class="section-header">
                    <h2>Recent Orders</h2>
                    <button class="view-all" (click)="setActiveTab('orders')">View All</button>
                </div>
                <div class="orders-list">
                    <div class="order-item" *ngFor="let order of dashboardData.recentOrders">
                        <div class="order-info">
                            <span class="order-id">{{ order.orderId }}</span>
                            <span class="order-date">{{ order.orderDate | date:'mediumDate' }}</span>
                        </div>
                        <div class="order-status" [ngClass]="order.status.toLowerCase()">{{ order.status }}</div>
                        <div class="order-total">₹{{ order.totalAmount }}</div>
                    </div>
                    <div class="no-orders" *ngIf="dashboardData.recentOrders.length === 0">
                        <p>No orders yet. Start your garden today!</p>
                    </div>
                </div>
            </section>
        </ng-container>

        <!-- Orders Tab -->
        <ng-container *ngIf="activeTab === 'orders' && !isLoading">
            <header class="content-header">
                <h1>My Orders</h1>
                <p>Track and manage your plant deliveries.</p>
            </header>

            <div class="orders-list full-history">
                <div class="order-item" *ngFor="let order of allOrders">
                    <div class="order-main-info">
                        <div class="order-header-row">
                            <span class="order-id">{{ order.orderId }}</span>
                            <span class="order-date">{{ order.orderDate | date:'longDate' }}</span>
                        </div>
                        <div class="order-items-preview">
                            <div class="item-pic" *ngFor="let item of order.items">
                                <img [src]="item.image" [alt]="item.name" title="{{item.name}}">
                            </div>
                        </div>
                    </div>
                    <div class="status-price-group">
                        <div class="order-status" [ngClass]="order.status.toLowerCase()">{{ order.status }}</div>
                        <div class="order-total">₹{{ order.totalAmount }}</div>
                    </div>
                </div>
                <div class="no-orders" *ngIf="allOrders.length === 0">
                    <p>You haven't placed any orders yet.</p>
                </div>
            </div>
        </ng-container>

        <!-- Profile Settings Tab -->
        <ng-container *ngIf="activeTab === 'settings' && !isLoading">
            <header class="content-header">
                <h1>Profile Settings</h1>
                <p>Update your personal information and preferences.</p>
            </header>

            <div class="settings-card">
                <div class="settings-form">
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" [value]="authService.currentUser$ | async" readonly>
                    </div>
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" value="user@example.com" readonly>
                        <small>Email cannot be changed.</small>
                    </div>
                    <div class="form-group">
                        <label>Phone Number</label>
                        <div class="phone-input-container">
                            <span class="country-prefix">+91</span>
                            <input type="text" [(ngModel)]="phone" placeholder="Enter your phone number"
                                class="settings-input">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>City</label>
                        <div class="state-autocomplete-container">
                            <input type="text" [(ngModel)]="city" (input)="onCityInput()" (blur)="closeDropdowns()"
                                placeholder="City" class="settings-input">
                            <div class="state-dropdown" *ngIf="showCityDropdown && filteredCities.length > 0">
                                <div class="state-option" *ngFor="let city of filteredCities"
                                    (click)="selectCity(city)">
                                    {{ city }}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>State</label>
                        <div class="state-autocomplete-container">
                            <input type="text" [(ngModel)]="stateName" (input)="onStateInput()"
                                (blur)="closeDropdowns()" placeholder="State" class="settings-input">
                            <div class="state-dropdown" *ngIf="showStateDropdown && filteredStates.length > 0">
                                <div class="state-option" *ngFor="let state of filteredStates"
                                    (click)="selectState(state)">
                                    {{ state }}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Shipping Address</label>
                        <textarea rows="3" [(ngModel)]="address" placeholder="Enter full address"></textarea>
                    </div>
                    <button class="save-btn">Save Changes</button>
                </div>
            </div>
        </ng-container>
    </main>
</div>